<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		<link rel=icon href=/content/images/favicon.ico>
		<title>JasperFx - Message Tracking</title>
		<link href="/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
		<link href="/content/JasperFx.css" rel="stylesheet" type="text/css" />
		<link href="/content/prism.css" rel="stylesheet" type="text/css" />
		<link href="/content/theme.css" rel="stylesheet" type="text/css" />




        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

        <!-- CSS code from Bootply.com editor -->
        <link href="/content/affix.css" rel="stylesheet" type="text/css" />
    </head>

    <!-- HTML code from Bootply.com editor -->

    <body  >


        <nav class="navbar navbar-default navbar-fixed-top" role="banner">
		  <div class="container">
		    <div class="navbar-header">
		      <a href="/" class="navbar-brand">JasperFx</a>
		    </div>
		    <nav class="collapse navbar-collapse" role="navigation">
		      <ul class="nav navbar-nav pull-right">
		        <li>
		          <a href="/documentation/getting_started">Getting Started</a>
		        </li>
		        <li>
		          <a href="/documentation">Documentation</a>
		        </li>
		        <li>
		        <li>
<a href="https://gitter.im/JasperFx/jasper?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/JasperFx/https://github.com/JasperFx/jasper" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
		        </li>
		      	<li><a href="/documentation/testing/storyteller" title="Using Storyteller against Jasper Systems">Previous</a></li>
		      	
		      </ul>
		      <div class="navbar-form navbar-left" role="search">
		        <div class="form-group">
		          <input id="search" type="search" class="form-control" placeholder="Search">
		        </div>
		      </div>

		    </nav>

		  </div>
		</nav>

		  <div class="container">
		  	<nav class="navbar-inverse">
		  		<ol class="breadcrumb"><li><a href="/">JasperFx</a></li><li><a href="/documentation">Documentation</a></li><li><a href="/documentation/testing">Automated Testing Support</a></li><li class="active">Message Tracking</li></ol>
		  	</nav>
		  </div>

		<!--main-->
		<div class="container">
			<div class="row">
		      <!--left-->

		      <div class="col-md-3" id="leftCol">
		      	<h3>JasperFx 0.8.2</h3>
		      	<br />

				<ul class="nav nav-stacked affix" id="sidebar">

		        </ul>

		        	
		        	<h3 class="no-margin">Previous</h3><a href="/documentation/testing/storyteller">Using Storyteller against Jasper Systems</a></p>

		        </ul>
		      </div><!--/left-->

		      <!--right-->
		      <div class="col-md-9">
			      	<h1>Message Tracking<a href="https://github.com/JasperFx/jasper/blob/master/documentation/documentation/testing/message_tracking.md"  class="text-muted small pull-right" style="margin-top: 10px"><i class="fa fa-github"></i> Edit on GitHub</a></h1>

			      	<hr />

			      	<div id="main-pane">
			      		<!--title:Message Tracking-->
<p>Automated testing against asynchronous processing applications can be very challenging. Let's say that when you're application handles a certain message it also sends out a couple cascading messages that in turn cause changes in state to the system
that you want to verify in your automated tests. The tricky part is how to invoke the original message, but then waiting for the cascading operations to complete before letting the test harness proceed to verifying the system state. Using <code>Thread.Sleep()</code> is <em>one</em> alternative, but usually results in either unnecessarily slow or horrendously unreliable automated
tests.</p>
<p>To at least amerliorate the issues around timing, Jasper comes with the &quot;Message Tracking&quot; feature that can be used as a helper in automated testing. To enable that in your applications, just include the extension as shown below:</p>
<pre><code class="language-csharp">&#xA;public class AppUsingMessageTracking : JasperRegistry&#xA;{&#xA;    public AppUsingMessageTracking()&#xA;    {&#xA;        // TODO -- need to change this when GH-346 is done&#xA;        Hosting.ConfigureAppConfiguration((context, config) =&gt;&#xA;        {&#xA;            var environment = context.HostingEnvironment.EnvironmentName;&#xA;&#xA;            if (environment == &quot;Development&quot; || environment == &quot;Testing&quot;)&#xA;            {&#xA;                // Don&#x27;t use this in production because it&#x27;d&#xA;                // cause a memory leak issue&#xA;                Include&lt;MessageTrackingExtension&gt;();&#xA;            }&#xA;        });&#xA;&#xA;&#xA;    }&#xA;}&#xA;</code></pre>
<p>Now, in testing you can use extension methods off of <code>JasperRuntime</code> that will execute an action with the service bus and
wait until all the work started (messages sent should be received, cascading messages should be completed, etc.) has completed --
or it times out in a reasonable time.</p>
<p>To use the message tracking, consider this skeleton of a test:</p>
<pre><code class="language-csharp">&#xA;public async Task invoke_a_message()&#xA;{&#xA;    using (var runtime = JasperRuntime.For&lt;AppUsingMessageTracking&gt;())&#xA;    {&#xA;        await runtime.InvokeMessageAndWait(new Message1());&#xA;&#xA;        // check the change in system state after the original&#xA;        // message and all of its cascading messages&#xA;        // finish&#xA;    }&#xA;}&#xA;</code></pre>
<p>The other usages of message tracking are shown below:</p>
<pre><code class="language-csharp">&#xA;public async Task other_usages()&#xA;{&#xA;    using (var runtime = JasperRuntime.For&lt;AppUsingMessageTracking&gt;())&#xA;    {&#xA;        // Call IMessageContext.Invoke() and wait for all activity to finish&#xA;        await runtime.InvokeMessageAndWait(new Message1());&#xA;&#xA;        // Configurable timeouts&#xA;        await runtime.InvokeMessageAndWait(new Message1(),&#xA;            timeoutInMilliseconds:10000);&#xA;&#xA;        // More general usage&#xA;        await runtime.ExecuteAndWait(() =&gt;&#xA;        {&#xA;            return runtime.Messaging.Send(new Message1());&#xA;        });&#xA;&#xA;        // More general usage, but synchronously&#xA;        await runtime.ExecuteAndWait(() =&gt;&#xA;        {&#xA;            runtime.Messaging.Send(new Message1());&#xA;        });&#xA;&#xA;        // Using an isolated message context&#xA;        await runtime.ExecuteAndWait(c =&gt; c.Send(new Message1()));&#xA;&#xA;        // Assert that there were no exceptions during the processing&#xA;        // If there are, this will throw an AggregateException of&#xA;        // all encountered exceptions in the message processing&#xA;        await runtime.ExecuteAndWait(c =&gt; c.Send(new Message1()),&#xA;            assertNoExceptions:true);&#xA;    }&#xA;}&#xA;</code></pre>

			      	</div>

			      	<hr />

			      	<nav>
				        <span>
				        	<strong>Previous: </strong><a href="/documentation/testing/storyteller">Using Storyteller against Jasper Systems</a>

				        </span>
				        <span class="pull-right">

				        	

				        </span>
			      	</nav>

		      </div><!--/right-->
		  	</div><!--/row-->
		</div><!--/container-->

<script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:http://jasperfx.github.io ' + search;
    url = encodeURI(url);

    //alert(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }



});

</script>
    </body>


    <foot>
        <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/content/embed.js"></script>
        <script type="text/javascript" src="/content/prism.js"></script>
        <script type="text/javascript" src="/content/sidebar.js"></script>
        <script type="text/javascript" src="/content/affix.js"></script>
    </foot>
</html>
